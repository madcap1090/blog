---
title: Am I getting slower going to work?
author: William Bourgeois
date: '2019-04-13'
slug: am-i-getting-slower-going-to-work
categories: 
  - geocoding
tags:
  - Geocoding
  - Google
  - R Markdown
---

I got a bit distracted writing the last post. What I want to find out is, based on my Google location history, how fast I bike to work and if this has changed over time. 

Attaching some libraries

```{r message=FALSE}
library("tidyverse")
library("lubridate")
library("glue")

```

And loading the data

```{r}

# the code to convert your location data to a data frame:
# see last post too
# data <- fromJSON("./data/Location History.json") # extracts a list
# locations <- data$locations # and the list contains a dataframe

location <- readRDS("~/R/blog/content/post/data/location.rds")

df <- location %>% 
  mutate(datetime = as.POSIXct(as.numeric(timestampMs)/1000, origin = "1970-01-01")) 

df <- df %>% 
  mutate(lat   = latitudeE7/1e7,
         lon   = longitudeE7/1e7,
         time  = strftime(datetime, format = "%H:%M:%S"),
         date  = date(datetime),
         year  = year(datetime),
         month = month(datetime),
         wday  = wday(datetime))


```

So what do we have here?

```{r}
nrow(df)                   # rows
length(unique(df$date))    # days
min(unique(df$date))       # first day
max(unique(df$date))       # last day

```

Plotted:

```{r}
ggplot(data = df, aes(x = datetime, y = lat))+
  geom_line()

```

I changed jobs in September 2014, my first working day at my current job was 15/09/2014.

Let's see which days I was working there. The dataframe "work", then contains all the data points from where I am at work.

```{r}

work <- df %>% 
  filter(date > "2014-09-14") %>%
  filter(round(lat,3) == 50.557) %>% 
  filter(round(lon,2) == 5.18) %>% # a little less accuracy on the longitude
  mutate(homework = "work") %>% 
  mutate(am_pm = case_when(am(datetime) ~ "am",
                           TRUE ~ "pm"))

length(unique(work$date)) 


```

```{r}
ggplot(data = work, aes(x = datetime, y = lat))+
  geom_line()

```


So that would mean that in my data set I have 330 working days and the data that comes along with it. 

Since at this point I am not interested in the data from days I was not working, these can be filtered out. 

```{r}
home <- df %>%
  filter(round(lat,3) != 50.557) %>% 
  filter(round(lon,2) != 5.18) %>%
  mutate(homework = "not_work") %>% 
  filter(date %in%(unique(work$date))) %>% 
  mutate(am_pm = case_when(am(datetime) ~ "am",
                           TRUE ~ "pm"))
```

Check if the dates are the same

```{r}
setdiff(unique(home$date),unique(work$date))  
```

Nice. The dates are equal. The home and work date frames can be binded.


```{r}
home_work <- rbind(home, work) %>% 
  arrange(datetime)
```

What days at work got tracked? 

```{r}
length(unique(home_work$date)) # workdays
min(unique(home_work$date))    # first day
max(unique(home_work$date))    # last day
```

Why is the latest day not in October 2018. Why does the series stop in July?

```{r}

day <- df %>% 
  filter(date > "2018-07-01") 

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line()


```

The date in October is just isolated. So there is less useful data in the dataset then I originally thought. 

To calculate the time of my daily commute I have to find the time between I last was at home and the time I arrived at work. 

The latitude changes during a typical working day look like this (although this one is particularly boring :unamused:).

```{r}
day <- df %>% 
  filter(date == "2014-12-23") 

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line()

```

```{r}
day <- df %>% 
  filter(date == "2014-12-23") %>% 
  filter(time > "07:00:00",
         time < "09:30:00")

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line()

```

So the time spent in the commute is the time first at around 50.560 latitude (itw) minus the last time at around 50.580 latitude (oth), and that for the time period of let's say between 7am and 9.30am.

```{r}
oth <- day %>% 
  filter(lat < 50.5756) %>% 
  filter(time == min(time)) %>% 
  select(time) %>% 
  mutate(time = as.POSIXct(time, format = "%H:%M:%S"))

itw <- day %>% 
  filter(lat < 50.557) %>% 
  filter(time == min(time)) %>% 
  select(time)%>% 
  mutate(time = as.POSIXct(time, format = "%H:%M:%S"))

commute_time <- difftime(itw$time,oth$time, units = c("mins")) #9.93 minutes
class(commute_time)
as.numeric(commute_time)



```

2 minutes is a bit too fast. The problem is that the first time out of the house, on that particular date, is recorded pretty late. So the last time in the house (ith) is the one that is needed. ALSO BECAUSE ADD THE STARTING ON 30/01/2016 ??? there is a strange pattern

```{r}
day <- home_work %>%
  filter(date == "2018-07-03") %>% 
  filter(time > "08:00:00",
         time < "09:30:00")

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line()
```

And that pattern did not happen before February 2016. For instance "2016-01-08" gives.

```{r}
day <- home_work %>%
  filter(date == "2016-01-08") %>% 
  filter(time > "07:30:00",
         time < "09:30:00")

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line()
```

A collegue came up with the hypothesis that it was my computer at home that was messing up my phone location data, which was a great idea, but in fact it was my tablet. 

I bought it on 30/01/2016, and both it's location data and my phone location data are merged ever since. Which is kind of surprising or rather dissapointing. 

Google is serving us dirty data in the location history. I cannot imagine they do not distinguish between my devises... ADD SCREENSHOT

```{r}
oth <- day %>% 
  filter(lat < 50.5756) %>% 
  filter(time == min(time)) %>% 
  select(time) %>% 
  mutate(time = as.POSIXct(time, format = "%H:%M:%S"))

# the last time in the house
ith <- day %>% 
  mutate(time = as.POSIXct(time, format = "%H:%M:%S")) %>% 
  filter(time < oth$time) %>% 
  filter(time == max(time))%>% 
  select(time) %>% 
  mutate(time = as.POSIXct(time, format = "%H:%M:%S"))


itw <- day %>% 
  filter(lat < 50.557) %>% 
  filter(time == min(time)) %>% 
  select(time)%>% 
  mutate(time = as.POSIXct(time, format = "%H:%M:%S"))

commute_time <- difftime(itw$time,ith$time, units = c("mins")) #9.93 minutes
class(commute_time)
as.numeric(commute_time)
```

17 minutes on the other hand seems a lot. But the data and calculations look correct to me. One explanation could be that sometimes there is a big delay in reporting the arrival time. Like on April 17 2015, where arrival was recorded after 12am.

```{r}
day <- df %>% 
  filter(date == "2015-04-17") 

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line()

```

So it's time to do some more data cleaning, and select dates that have data from both work and home between 7 and 9:30am.

```{r}
keep_dates <- home_work %>% 
  filter(time > "07:00:00",
         time < "09:30:00") %>%
  plyr::count(c('date', 'homework')) %>% 
  spread(homework, freq) %>% 
  filter(work > 0) %>% 
  select(date)
glue("so there are now {nrow(keep_dates)} days to be analysed")
```

Let's define a function to do it.

```{r}
# building the function

get_time_am <- function(x_date){
    day <- home_work %>%
    filter(date ==  x_date) %>% 
    filter(time > "07:30:00",
           time < "09:30:00")
  oth <- day %>% 
    filter(lat < 50.5756) %>% 
    filter(time == min(time)) %>% 
    select(time) %>% 
    mutate(time = as.POSIXct(time, format = "%H:%M:%S"))
  
  ith <- day %>% 
    mutate(time = as.POSIXct(time, format = "%H:%M:%S")) %>% 
    filter(time < oth$time) %>% 
    filter(time == max(time))%>% 
    select(time) %>% 
    mutate(time = as.POSIXct(time, format = "%H:%M:%S"))

    itw <- day %>% 
    filter(lat < 50.558) %>% 
    filter(time == min(time)) %>% 
    select(time)%>% 
    mutate(time = as.POSIXct(time, format = "%H:%M:%S"))
  
  x <- difftime(itw$time,ith$time, units = c("mins"))
  class(x)
  as.numeric(x)
  print(ith)
  print(itw)
  print(x)
}

```





```{r}
day <- home_work %>% 
  filter(date == "2016-06-15") 

ggplot(data = day, aes(x = datetime, y = lat))+
  geom_line(aes(color = homework))
```

Finally I wanted to share the pat√©s with you. Not often enough 
