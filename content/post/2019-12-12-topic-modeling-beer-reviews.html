---
title: Topic modeling beer reviews
author: William Bourgeois
date: '2019-12-12'
slug: topic-modeling-beer-reviews
categories: []
tags:
  - nlp
  - Beers
  - topic modeling
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>


<p>Another tool to analyse our text data with is topic modeling. This might seem similar to the tf-idf calculations but the biggest difference in topic modeling is that here we will see if we can learn something by seeing which words tend to be used in the same reviews. While the tf-idf only looks at the occurrence of the word compared to the total occurrences of all the other words.</p>
<p>I got the guidance for the wrangling the data from an article by Igor Hut <a href="https://rpubs.com/MajstorMaestro/256588">here</a> and also the article by Dmitriy Selivanov. <a href="https://cran.r-project.org/web/packages/text2vec/vignettes/text-vectorization.html">here</a>.</p>
<p>Further inspiration and guidance came from <a href="https://cfss.uchicago.edu/notes/topic-modeling/">Chicago U</a>.</p>
<pre class="r"><code>library(&quot;tidyverse&quot;)
library(&quot;qdap&quot;)
library(&quot;text2vec&quot;)
library(&quot;DT&quot;)
library(&quot;tm&quot;)
library(&quot;ggplot2&quot;)
library(&quot;viridis&quot;)
library(&quot;digest&quot;)
library(&quot;cld2&quot;)</code></pre>
<p>Our data is, like you remember, a data frame with 3.978 rows with one column containing the 154.896 reviews (spread over the different rows of the beers).
What we want to use is a document term matrix (dtm), with one row per beer and a column per (cleaned and filtered) word. The values inside the matrix can be the number of times the word appears or another calculation (like the tf_idf).</p>
<pre class="r"><code>input &lt;- readRDS(&quot;~/R/blogs/content/post/data/20191113/output_final_cleaned.rds&quot;) 
 
treat_comment &lt;- function(text){
  text &lt;- gsub(&#39;[[:digit:]]+&#39;,&#39;&#39;, text)
  text &lt;- gsub(&#39;[\n]&#39;,&#39; &#39;, text)
  text &lt;- gsub(&#39;[^[:alpha:]]+&#39;,&#39; &#39;, text)
  text &lt;- gsub(&#39;[[:punct:]]+&#39;,&#39; &#39;, text)
  text &lt;- tolower(text)
  text &lt;- gsub(&quot;characters&quot;, &quot;characters &quot;, text)
  text &lt;- gsub(&#39;look smell taste feel overall&#39;,&quot;&quot;,text)
  text &lt;- gsub(&#39;rdev&#39;,&quot;&quot;,text)
  text &lt;- gsub(&#39;characters&#39;,&quot;&quot;,text)
  text &lt;- gsub(&#39;report like&#39;,&quot;&quot;,text)
  text &lt;- gsub(&#39;member likes this&#39;,&quot;&quot;,text)
  text &lt;- str_squish(text)
  return(text)
}

input_cleaned &lt;- input %&gt;%
  unnest(cols = c(comments)) %&gt;% 
  mutate(comments = map_chr(comments, treat_comment)) %&gt;%
  mutate(hash = map(comments,sha1)) %&gt;% 
  mutate(i = as.numeric(i)) 

input_cleaned &lt;- input_cleaned %&gt;%
    mutate_all(unlist)</code></pre>
<p>So original input:</p>
<pre class="r"><code>input %&gt;% select(i, comments) %&gt;% 
  slice(9) %&gt;% 
  mutate(comments = substr(comments,1,765)) %&gt;% 
  datatable(rownames = FALSE,  options = list(dom  = &#39;t&#39;))</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","data":[["9"],["list(\"3.48/5  rDev -4.7%look: 3.5 | smell: 3.5 | taste: 3.75 | feel: 2.75 | overall: 3.25750ml caged and corked(fake) bottle. 1I see 1-12(months?) and 13-19(years?) but nothing is notched. \\nRemoving the fake cork, I got silence. Hint of lack of carbonation...could be. \\nThe pour shows a murky reddish brown, tiny head of foam that's gone almost instantly. No lacing. \\nSmells of sour cherries, some acetic acidity, light aromas of Brett. \\nCherries and Brett are very assertive without being overly tart. Hint or 2 of vanilla. \\nLightish body with the slightest bit of carbonation or..I could be imagining it. \\nAll in all, this comes across to me very wine like. Good enough for me to finish the bottle. 617 charactersBitterbill, Oct 02, 2018  Report  Like\", \n  "]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>i<\/th>\n      <th>comments<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<hr />
<p>Cleaned input:</p>
<pre class="r"><code>input_cleaned %&gt;% select(i, comments) %&gt;% 
  slice(1) %&gt;% 
  mutate(comments = substr(comments,1,1500)) %&gt;% 
  datatable(rownames = FALSE,  options = list(dom  = &#39;t&#39;))</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","data":[[9],["ml caged and corked fake bottle i see months and years but nothing is notched removing the fake cork i got silence hint of lack of carbonation could be the pour shows a murky reddish brown tiny head of foam that s gone almost instantly no lacing smells of sour cherries some acetic acidity light aromas of brett cherries and brett are very assertive without being overly tart hint or of vanilla lightish body with the slightest bit of carbonation or i could be imagining it all in all this comes across to me very wine like good enough for me to finish the bottle bitterbill oct"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>i<\/th>\n      <th>comments<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","columnDefs":[{"className":"dt-right","targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<hr />
<p>The last three words in the review are probably inserted automatically; the user name, the number of characters, and month of the review. We can calculate the number of reviews per user and then filter out these last three words too.</p>
<pre class="r"><code>users &lt;- input_cleaned %&gt;% 
  mutate(n_words = str_count(comments, &#39;\\w+&#39;)) %&gt;% 
  mutate(user= word(comments,n_words-1)) %&gt;% #taking all but the last three words
  select(user, n_words, comments)

users %&gt;% group_by(user) %&gt;% 
  summarise(count = n()) %&gt;% 
  arrange(desc(count))</code></pre>
<pre><code>## # A tibble: 14,595 x 2
##    user          count
##    &lt;chr&gt;         &lt;int&gt;
##  1 desint          687
##  2 phylca          498
##  3 blackhaddock    430
##  4 metter          398
##  5 thierrynantes   397
##  6 uclabrewn       392
##  7 sammy           388
##  8 beerchitect     387
##  9 superspak       368
## 10 paterlodie      367
## # ... with 14,585 more rows</code></pre>
<p>The top ones have been quite prolific.</p>
<p>And the beer types that got the most reviews are the following ones:</p>
<pre class="r"><code>users_type &lt;- input_cleaned %&gt;% 
  mutate(n_words = str_count(comments, &#39;\\w+&#39;)) %&gt;% 
  mutate(user= word(comments,n_words-1)) %&gt;% #taking all but the last three words
  select(user, n_words, comments, beer_type)

top_10 &lt;- users_type %&gt;% group_by(beer_type) %&gt;% 
  summarise(count = n()) %&gt;% 
  arrange(desc(count)) %&gt;% 
  head(10)

top_10 %&gt;% 
  ggplot(aes(x=reorder(beer_type, count), y=count)) +
  geom_bar(stat=&quot;identity&quot;, width=0.6, fill= &quot;steelblue&quot;) +
  coord_flip()+
  theme_minimal()+
  labs(x=NULL) </code></pre>
<p><img src="/post/2019-12-12-topic-modeling-beer-reviews_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>We can clean the text further, only keeping English reviews and get rid of small or empty reviews :</p>
<pre class="r"><code>input_cleaned &lt;- input_cleaned %&gt;%
  mutate(language = detect_language(text = comments)) %&gt;% 
  filter(language == &quot;en&quot;) %&gt;% 
  select(-language)

input_cleaned &lt;- input_cleaned %&gt;% 
  mutate(n_words = str_count(comments, &#39;\\w+&#39;)) %&gt;% 
  mutate(review= word(comments, 1, n_words-2)) %&gt;% 
  select(-comments) %&gt;% 
  filter(nchar(review) &gt; 25)

it_all &lt;- itoken(unlist(input_cleaned$review),
                        tokenizer = word_tokenizer,
                        ids = input_cleaned$i)

# removing some words along with stop words
stop_words &lt;- stopwords(kind = &quot;en&quot;)

remove_words &lt;- c(stop_words,
                  &quot;s&quot;,&quot;m&quot;,&quot;d&quot;,&quot;ve&quot;,&quot;st&quot;, &quot;review&quot;, &quot;one&quot;,
                  &quot;t&quot;, &quot;cl&quot;, &quot;w&quot;, &quot;ml&quot;, &quot;re&quot;, &quot;gt&quot;, &quot;bit&quot;,
                  &quot;characters&quot;, &quot;beer&quot;, &quot;bottle&quot;, &quot;glass&quot;, 
                  &quot;head&quot;, &quot;beers&quot;, &quot;can&quot;, &quot;oz&quot;)

vocabulary &lt;- create_vocabulary(it_all,
                                stopwords = remove_words,)

vocabulary %&gt;% arrange(desc(term_count)) %&gt;%
  slice(1:1250) %&gt;% 
  datatable(rownames = FALSE, class = &quot;compact&quot;)</code></pre>
<div id="htmlwidget-3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-3">{"x":{"filter":"none","data":[["taste","sweet","like","light","nice","carbonation","good","dark","well","white","alcohol","aroma","yeast","flavor","finish","smell","sour","brown","little","color","medium","fruit","belgian","pours","malt","mouthfeel","body","notes","just","lacing","poured","dry","really","nose","great","much","flavors","tart","quite","sweetness","fruity","overall","slightly","smooth","hops","orange","caramel","style","strong","fruits","drink","sugar","slight","golden","almost","red","spicy","spice","citrus","cherry","creamy","pretty","also","complex","first","thick","apple","brew","hazy","lemon","bodied","bitterness","big","full","lots","malts","appearance","funk","still","thin","ale","feel","smells","get","high","hint","palate","finger","best","bitter","mouth","drinkable","mild","amber","way","drinkability","though","hop","deep","even","spices","time","cherries","clear","aftertaste","malty","touch","retention","yeasty","abv","cloudy","balanced","pale","character","hints","quickly","around","lace","crisp","earthy","yellow","definitely","chocolate","lot","rich","back","leaves","better","tulip","pour","bubbles","end","tastes","o","honey","foam","banana","wine","aromas","small","think","tartness","try","easy","tan","oak","sourness","refreshing","top","amount","maybe","balance","carbonated","decent","tongue","will","funky","fairly","bread","floral","long","moderate","clove","pepper","interesting","huge","fresh","something","front","don","raisins","bready","clean","enough","two","lambic","green","excellent","apples","sip","comes","present","pleasant","tripel","drinking","along","heavy","black","yet","bad","vinegar","subtle","soft","makes","finishes","candy","gold","somewhat","foamy","sure","going","doesn","seems","rather","right","wheat","nothing","served","fine","side","come","solid","another","complexity","worth","expected","say","enjoyable","note","tasty","perfect","low","make","nicely","warms","fluffy","see","herbal","tap","warming","looking","pear","left","ever","got","bright","looks","coriander","large","many","beautiful","love","faint","less","ruby","lightly","saison","vanilla","grape","leaving","sticky","presence","acidic","chalice","delicious","straw","date","musty","find","peppery","slowly","probably","go","colored","raisin","cap","isn","esters","never","plum","goes","raspberry","kind","frothy","quality","tasting","lingering","grapes","toffee","wonderful","different","highly","know","fruitiness","hard","without","roasted","grassy","favorite","thing","dried","reddish","pink","colour","belgium","bubbly","spiciness","murky","plums","throughout","now","acidity","mostly","hoppy","actually","certainly","old","extremely","average","enjoyed","away","similar","look","label","figs","sharp","perhaps","level","inch","starts","champagne","juice","profile","duvel","cork","half","didn","enjoy","however","middle","goblet","barnyard","hidden","ll","plenty","followed","fizzy","hay","sediment","amazing","fades","bite","far","flavour","noticeable","fingers","last","background","unique","warm","coffee","chimay","real","want","thanks","molasses","day","although","mix","gueuze","might","peach","snifter","tried","apricot","wood","give","may","found","classic","lighter","made","years","tasted","behind","ripe","cinnamon","scent","grain","sugary","take","vintage","copper","super","fantastic","cantillon","peel","expect","candi","grass","coming","experience","stuff","ring","lively","typical","overly","dubbel","reminds","start","opaque","must","especially","every","hue","easily","lingers","bottom","mixed","world","thought","bottled","quad","cider","cloves","corked","texture","surprisingly","year","price","gives","new","dissipates","layer","syrupy","whole","booze","dense","fig","least","settles","getting","three","let","lasting","candied","toasted","intense","wow","feels","things","brewery","raspberries","beige","dryness","pears","gets","zest","cream","de","minimal","grainy","night","dates","boozy","nearly","tiny","aged","buy","ales","together","anything","flavours","pick","wasn","trying","example","sort","due","wet","else","semi","effervescent","grapefruit","blend","expecting","warmth","follows","lovely","initial","awesome","everything","watery","tons","trappist","despite","mildly","towards","short","burnt","alcoholic","liquid","vinous","mahogany","mind","since","others","mellow","maltiness","lemony","woody","part","bottles","always","massive","either","cloying","hot","stout","ok","keep","near","put","seem","drank","metallic","f","rocky","minutes","said","brett","special","incredibly","upfront","absolutely","puckering","citrusy","across","point","ipa","next","summer","second","delicate","hit","times","perfectly","age","phenols","forward","glad","held","impressive","lactic","wild","highlights","type","becomes","sweeter","done","bernardus","christmas","purchased","overpowering","wouldn","medicinal","hits","picked","kriek","prunes","moderately","tangy","syrup","haze","used","tones","initially","came","damn","completely","version","cheese","couple","bananas","berries","bought","sugars","nutty","cocoa","rochefort","sides","recommended","blonde","session","recommend","belgians","feeling","given","fan","edges","seen","wish","takes","prickly","earthiness","licorice","kick","cellar","lambics","soon","base","depth","surface","edge","making","darker","cold","subdued","grains","strawberry","floating","pineapple","acid","juicy","prefer","sticks","pop","adds","liked","earth","pint","relatively","flat","triple","lasts","tropical","nutmeg","truly","close","leather","smelling","active","shows","immediately","spiced","guess","simple","fair","evident","film","upon","citric","characteristics","believe","place","treat","visible","higher","combination","l","apparent","finally","gentle","standard","offering","bubblegum","fact","brings","smelled","barrel","caged","recedes","qualities","mid","chewy","outstanding","dominate","water","strength","incredible","phenolic","reviewed","odd","content","prominent","work","overwhelming","pronounced","leave","tad","cola","astringent","sipper","barely","rum","soapy","true","round","backbone","drying","pack","reminiscent","class","flavorful","tripels","opinion","simply","add","burn","heat","silky","funkiness","impression","course","lager","berry","american","winter","otherwise","available","slick","tea","appears","bold","tight","sitting","oh","took","stays","purple","sense","need","flanders","bubble","several","went","giving","considering","compared","definite","fantome","slow","remains","peaches","drinks","quick","works","tall","distinct","biscuit","apricots","inviting","lemons","describe","throat","keeps","surprised","linger","weak","dominated","blanket","rising","room","says","ginger","horse","ago","yeastiness","plus","strange","seemed","exactly","brewed","fast","oaky","traditional","soda","people","rind","pilsner","coating","warmed","won","brownish","temperature","pouring","added","particularly","impressed","store","sized","pure","brews","yeasts","exceptional","forms","regular","dominant","scents","oranges","anise","swallow","sampled","cheers","falls","use","herbs","tell","felt","sits","cool","past","sipping","capped","stronger","blue","opened","open","food","sips","form","months","dessert","prune","couldn","la","lime","later","topped","lack","often","elements","wit","entire","acetic","witbier","spotty","lacking","presentation","aspect","non","th","rounded","clarity","finishing","happy","show","muted","shared","rest","dissipated","harsh","line","aging","wonderfully","become","remember","loads","crystal","straight","stick","sensation","stone","started","abbey","gone","toward","able","ends","estery","dirty","ton","wait","case","skin","aggressive","sours","oily","cake","farmhouse","lower","spritzy","yes","opens","stand","means","mainly","turns","noticed","bar","usually","blended","within","ish","finished","gorgeous","hues","pillowy","barley","weird","eventually","dough","dominates","underneath","call","powerful","detect","aromatic","surprising","chestnut","flowers","fridge","pleasantly","kinda","collar","effervescence","buttery","amounts","instead","begins","pleasing","grand","cut","pine","nuts","atop","reason","holds","punch","port","pungent","pinkish","hoppiness","roast","lacks","possibly","opening","home","disappointed","crazy","drinker","quads","consumed","blond","name","sit","indeed","toasty","hazed","extra","chance","residual","zesty","haven","notice","reviews","airy","surprise","whiff","gave","unfortunately","difficult","appreciate","retains","wrong","freshness","local","beginning","translucent","faded","robust","milk","mf","westmalle","goodness","astringency","chunks","bring","imagine","appealing","pie","noted","single","none","khaki","draft","ample","help","tobacco","four","orval","creaminess","hold","tinge","pucker","center","biscuity","mustiness","helps","doughy","except","unlike","dinner","life","already","superb","ounce","produced","ba","rose","bone","spot","serving","modest","chilled","someone","hell","usual","friend","flowery","disappears","styles","effect","disappointing","seek","us","westy","brandy","coats","roasty","score","dose","velvety","dull","flute","tingly","unpleasant","smoke","settled","play","change","underlying","leffe","persistent","characteristic","reminded","sample","appropriate","artificial","totally","lindemans","soaked","size","undertones","flavored","westvleteren","somehow","breadiness","froth","saisons","dupont","bits","doubt","spicey","hope","forever","tannic","hand","attractive","laces","mineral","satisfying","looked","future","bouquet","dated","expensive","nonetheless","picking","cranberry","tang","needs","caramelized","filling","dusty","ones","geuze","bubbled","strongly","tone","wanted","carb","melon","man","provides","firm","generous","late","brought","nature","speak","toast","friends","masked","general","burgundy","certain","delirium","shot","okay","lasted","face","enjoying","minor","evening","holiday","chunky","strawberries","gum","addition","taking","based","buds","fermented","pleasure","brussels","flemish","clearly","floaties","substantial","y","careful","temp","smoothness","bland","batch","particular","filled","deal","wife","anyone","sparkling","crafted","problem","stands","anyway","detectable","raw","restrained","beautifully","fun","obviously","brilliant","sherry","detected","original","obvious","likely","b","rating","wanting","balsamic","hardly","muddy","trace","garnet","natural","hype","wheaty","days","including","swirl","split","abt","normal","bruin","touches","vinegary","unusual","power","baked","vibrant","covered","mean","showing","beverage","choice","cru","honestly","inside","list","follow","known","house","turn","bourbon","aspects","tannins","putting","cough","noble","rate","drops","alot","young","minute","particles","gift","thickness","etc","bigger","chalky","heavily","offerings","liquor","clings","somewhere","among","oud","glasses","sharing","combined","crown","leads","traces","taken","hoping","ending","reduces","lived","loved","ester","kept","brewing","main","levels","hides","element","expectations","mixture","intensity","component","monk","today","balances","set","chouffe","dubbels","terms","fully","covering","significant","fizz","degrees","assertive","lost","wonder","produces","bsda","carries"],[107348,96547,95254,93902,87825,83911,82580,77332,65103,63866,63166,62922,62226,59716,58925,55322,55134,54563,53970,53868,53351,53275,52178,52114,51871,51238,50687,47942,45633,45396,45279,44194,42827,40396,39141,38522,37443,37360,37344,37088,36658,34511,34318,32766,32477,32060,29911,29671,28819,28370,27819,27694,27023,26985,26636,26564,26283,25672,25646,25574,25540,25370,25306,25033,24539,24462,24322,24288,24200,23805,23775,23406,22974,22214,22043,21973,21791,21780,21773,21686,21626,21433,21305,21018,20662,20655,20450,20133,20048,19775,19733,19610,19231,19115,18739,18650,18552,18404,18399,18305,18262,18246,17886,17719,17598,17567,17523,17395,17288,17185,17112,17105,17083,17068,17035,16956,16910,16787,16723,16548,16356,16280,16205,15984,15855,15721,15577,15537,15516,15483,15457,15266,15181,15147,15087,14993,14938,14915,14883,14833,14822,14652,14617,14605,14595,14297,14109,14069,14038,13856,13646,13574,13518,13480,13458,13382,13312,13298,13003,12820,12797,12689,12567,12425,12383,12371,12149,12045,12043,12037,11967,11827,11794,11786,11786,11723,11706,11654,11502,11381,11306,11185,11178,11176,11089,11077,10960,10869,10816,10791,10696,10688,10677,10611,10585,10535,10521,10442,10394,10378,10360,10288,10223,10197,10162,10020,9992,9972,9962,9892,9881,9867,9681,9662,9605,9553,9519,9426,9396,9338,9324,9307,9269,9248,9185,9090,9079,9068,9034,9024,9010,8965,8878,8875,8874,8857,8812,8776,8760,8741,8734,8714,8642,8617,8543,8520,8485,8437,8380,8294,8254,8230,8218,8212,8182,8154,8139,8117,8092,8078,8029,7991,7927,7919,7917,7901,7883,7805,7778,7744,7663,7604,7582,7522,7514,7483,7452,7446,7445,7436,7396,7383,7336,7330,7299,7293,7267,7211,7188,7160,7153,7153,7108,7021,6995,6992,6989,6955,6951,6908,6897,6877,6875,6849,6846,6843,6829,6824,6817,6781,6756,6754,6733,6730,6724,6724,6722,6712,6706,6638,6635,6635,6612,6548,6542,6494,6490,6484,6483,6476,6474,6473,6428,6421,6396,6393,6377,6366,6308,6287,6272,6261,6258,6247,6216,6146,6127,6122,6111,6053,6028,6010,6007,6006,6003,5990,5969,5963,5953,5936,5906,5900,5871,5871,5832,5820,5799,5783,5763,5745,5718,5690,5642,5635,5598,5555,5499,5481,5468,5447,5444,5399,5379,5368,5366,5361,5355,5329,5304,5291,5273,5228,5223,5208,5203,5186,5139,5123,5097,5092,5063,5061,5047,5039,5005,4985,4964,4898,4856,4848,4847,4840,4816,4801,4787,4770,4742,4716,4709,4693,4678,4673,4673,4666,4661,4631,4630,4629,4623,4614,4608,4595,4593,4590,4572,4554,4550,4544,4514,4499,4453,4429,4407,4397,4393,4392,4364,4352,4348,4330,4317,4308,4305,4299,4260,4256,4250,4219,4215,4214,4213,4197,4167,4124,4122,4119,4116,4116,4111,4108,4107,4091,4040,4038,4009,4006,4002,3986,3983,3976,3961,3956,3934,3932,3913,3907,3882,3870,3867,3867,3838,3834,3827,3782,3776,3772,3772,3771,3767,3726,3720,3711,3706,3697,3683,3661,3655,3654,3638,3634,3633,3630,3626,3622,3612,3611,3606,3577,3564,3564,3552,3538,3530,3518,3516,3515,3507,3505,3504,3503,3488,3487,3471,3466,3465,3456,3452,3448,3445,3441,3431,3428,3426,3423,3407,3402,3385,3381,3369,3365,3352,3345,3337,3336,3333,3330,3328,3322,3312,3311,3302,3301,3298,3290,3270,3254,3254,3231,3218,3214,3193,3155,3154,3153,3150,3150,3141,3138,3137,3132,3123,3123,3115,3114,3112,3108,3100,3098,3096,3073,3058,3051,3041,3038,3031,3029,3023,3014,3004,3003,2989,2987,2986,2977,2967,2964,2955,2940,2939,2938,2934,2932,2927,2915,2913,2908,2905,2904,2903,2872,2866,2857,2857,2852,2847,2843,2840,2833,2812,2810,2810,2805,2804,2803,2795,2791,2786,2782,2779,2773,2771,2758,2754,2732,2727,2725,2724,2720,2716,2711,2705,2694,2684,2674,2668,2668,2657,2643,2641,2623,2621,2618,2597,2583,2571,2569,2567,2561,2558,2558,2555,2554,2544,2544,2543,2538,2536,2529,2528,2526,2523,2522,2520,2507,2503,2503,2497,2489,2486,2483,2482,2476,2474,2474,2473,2470,2466,2460,2450,2446,2444,2436,2427,2421,2420,2418,2416,2412,2409,2407,2405,2404,2402,2398,2396,2394,2392,2386,2386,2384,2383,2382,2366,2359,2352,2351,2350,2345,2344,2339,2321,2305,2302,2300,2300,2295,2295,2280,2269,2267,2259,2257,2255,2251,2249,2243,2240,2224,2223,2222,2218,2218,2217,2214,2207,2200,2200,2193,2192,2190,2190,2189,2180,2162,2154,2152,2151,2145,2144,2143,2141,2140,2138,2136,2127,2123,2121,2120,2111,2108,2107,2104,2103,2089,2083,2070,2060,2058,2058,2052,2042,2040,2037,2036,2035,2032,2026,2022,2022,2020,2016,2010,2008,2006,1999,1998,1992,1979,1971,1969,1958,1957,1955,1953,1951,1948,1946,1938,1934,1933,1917,1916,1916,1912,1908,1906,1905,1901,1893,1887,1886,1879,1877,1874,1873,1869,1858,1853,1844,1844,1834,1833,1829,1823,1821,1818,1816,1815,1814,1809,1804,1802,1801,1800,1794,1792,1786,1785,1784,1779,1778,1777,1777,1775,1775,1774,1770,1757,1750,1749,1748,1746,1740,1738,1736,1736,1734,1732,1720,1720,1719,1716,1715,1712,1710,1709,1707,1706,1705,1704,1703,1703,1699,1699,1699,1691,1690,1685,1683,1680,1675,1675,1674,1673,1670,1668,1667,1667,1666,1665,1661,1661,1661,1659,1655,1653,1649,1645,1640,1638,1636,1626,1625,1625,1619,1616,1612,1611,1610,1608,1606,1604,1603,1601,1601,1600,1599,1598,1594,1593,1593,1591,1590,1585,1583,1583,1583,1582,1577,1574,1573,1571,1568,1566,1565,1563,1563,1563,1562,1561,1558,1558,1557,1555,1553,1550,1541,1539,1537,1535,1534,1530,1530,1529,1528,1518,1518,1514,1513,1511,1510,1508,1505,1503,1498,1497,1491,1491,1489,1485,1485,1484,1484,1479,1479,1478,1476,1475,1475,1473,1473,1471,1468,1466,1466,1465,1464,1460,1459,1454,1453,1453,1451,1450,1450,1449,1448,1448,1447,1442,1437,1435,1433,1431,1430,1428,1428,1428,1428,1428,1428,1424,1423,1421,1420,1419,1417,1415,1415,1414,1413,1413,1412,1411,1410,1409,1409,1409,1407,1407,1405,1401,1400,1400,1398,1396,1394,1393,1391,1387,1387,1386,1386,1383,1382,1381,1377,1376,1376,1375,1373,1370,1370,1369,1369,1368,1368,1367,1365,1363,1362,1361,1358,1354,1349,1348,1345,1345,1344,1339,1336,1330,1329,1323,1322,1321,1320,1319,1318,1318,1316,1314,1313,1310,1307,1306,1302,1301,1301,1300,1299,1299,1298,1298,1295,1294,1294,1293,1292,1290,1290,1290,1289,1284,1283,1280,1277,1276,1275,1275,1273,1271,1262,1262,1262,1261,1260,1258,1255,1254,1253,1252,1251,1250,1250,1247,1247,1244,1241,1241,1241,1238,1233,1231,1223,1222,1216,1215,1215,1214,1207,1206,1205,1204,1204,1201,1200,1199,1198,1194,1189,1187,1184,1182,1180,1178,1178,1178,1177,1173,1172,1168,1162,1159,1159,1158,1157,1153,1149,1147,1146,1144,1144,1143,1143,1142,1141,1140,1139,1138,1138,1135,1133,1133,1129,1128,1127,1125,1122,1122,1122,1121,1121,1119,1117,1115,1114,1114,1113,1113,1111,1109,1108,1107,1107,1105,1104,1104,1102,1101,1101,1100,1098,1098,1097,1096,1096,1095,1093,1091,1091,1090,1088,1086,1085,1083,1081,1080,1079,1078],[80988,63385,60255,60231,56214,71036,57028,46802,47522,55965,43914,51075,42753,43914,49057,45256,31258,42258,38186,51119,45003,38788,36136,51640,37087,48118,44340,34008,34229,44662,42037,35632,31103,34120,30214,31012,28450,25511,28326,29486,29079,31786,27991,28695,24246,25743,21721,24067,22878,22093,24211,20572,21762,25745,22538,21287,20381,20154,19817,15367,21862,20248,20901,21293,20688,21360,17589,18412,24049,17034,23402,20700,18880,19782,18042,16864,20925,15059,18529,19482,16932,18896,19558,17576,18254,17745,17269,19498,17805,16680,17578,18885,15219,18367,16550,17984,15632,14805,16803,15737,14415,15522,12614,17299,16552,14987,14305,17226,14913,15604,16919,15238,13948,13037,14613,16023,15345,16503,14708,13041,16010,14063,10963,13754,12471,13913,14706,13894,15178,14036,14128,13700,13962,15005,11035,13815,11296,11737,12992,13490,12945,11629,13452,13655,14426,9624,10867,12518,12951,11615,11962,11595,12876,12102,12093,11834,10463,11364,10529,10093,11807,10396,9782,9907,10837,11333,10037,10615,11326,10686,9909,9844,10144,10419,10964,8173,9066,10184,9420,9970,10200,9896,10229,8011,10311,9801,9657,8693,9440,9646,7564,9336,8829,9855,10271,8656,10318,9401,9970,9411,9385,9304,8990,8801,9209,7314,8933,9504,8916,8614,9072,8870,8987,8279,9195,8779,8612,8837,7863,8743,8111,8377,8648,8489,8240,8832,8399,6759,7810,8387,8370,7060,8454,8013,7995,7951,8305,6793,8308,7984,8134,7699,7507,7767,8436,7185,5564,6734,6464,8012,7752,7193,6632,7875,7327,7475,7420,6706,7429,7010,7739,7449,7459,7589,6442,7349,6860,6526,7122,6215,7309,4514,6761,7342,6628,6956,7159,6055,5927,6541,6632,6955,6683,6579,6780,6796,5535,5913,6744,6632,5799,7078,6231,6679,6041,6567,6083,6864,5989,6531,6244,5422,6445,5911,6244,6208,5785,6171,5943,6415,6419,6402,6391,5805,5737,6032,6060,6102,6423,6285,5463,5380,5919,5208,5558,6064,5888,6075,5972,6111,6158,5474,6216,5950,5745,5984,5872,5185,5780,5514,6071,5861,5759,4861,5622,6080,5713,5735,5359,5537,4068,4801,5387,5602,5629,4875,5522,5430,5437,3917,5421,4395,5688,5458,4492,4795,5478,5287,5379,5097,5255,5360,4933,5312,5363,4867,4651,4819,4555,4796,5157,4897,5311,4715,4791,3767,4510,5017,3999,4290,4886,4816,4717,5108,4885,4785,4823,4050,4808,4826,5023,4732,4839,4630,4950,4758,4790,4684,4448,4488,4483,4658,3762,3871,3979,4712,4483,4518,4138,4340,4394,4356,4650,4539,4236,4383,3668,4389,3809,4368,4521,4269,4370,4272,4436,3827,3616,3995,4229,4314,4136,4003,2980,4379,4029,3800,4121,3691,3910,3663,4089,3676,4024,3645,3694,4014,4007,3626,4059,3835,3944,3950,3437,3849,3755,3983,3967,3720,3895,3565,3916,3761,3896,3240,3648,3715,3758,3946,3575,3746,3564,3731,3610,3523,3244,3739,3564,3614,3720,3368,3441,3566,3197,3767,3633,3500,3564,3380,3472,3312,3235,3497,3372,3423,3494,3512,3510,3384,2428,3337,3468,3461,3488,3426,3444,3017,3364,3544,3408,3379,2567,3292,3229,3326,3269,3269,3177,3258,3346,2628,3321,3242,3231,3092,3282,3183,3221,3069,2816,3276,3369,3334,3181,2621,2800,3371,3201,3167,3183,3204,2809,2629,3281,3218,3195,2798,3198,3225,2416,2844,3048,2816,2845,3260,3082,2911,3097,3007,2957,3059,2786,2653,3027,2708,2695,3050,2681,2765,2447,2381,3041,3080,2611,2987,3060,2881,2973,2889,2978,2969,2946,2950,2952,2955,2278,2350,2902,2809,2561,2902,2719,2798,2901,2740,2855,2772,2759,2820,2465,1962,2869,2368,2382,2533,2830,2850,2784,2720,2743,2438,2761,2710,2514,2215,2669,2387,2500,2643,2682,2319,2707,2632,2628,2691,2486,2669,2503,2634,2588,2728,2628,2359,2611,2623,2630,2628,2662,2557,2576,2584,2546,2592,2443,2481,2516,2182,2539,2495,2525,1991,2608,2599,2386,2488,2449,2424,2493,2393,2420,2279,2262,2450,2259,2418,2390,2442,2457,2425,2479,2408,2165,2357,2477,2416,2037,2408,2365,2389,2412,2370,2247,2419,2351,2393,2104,2400,2298,2337,2281,2197,2353,2159,2209,2337,1853,1991,2172,2090,2329,2319,2356,2022,2334,2204,2320,2341,2258,2275,2284,2159,2176,2317,1982,2166,2269,2257,2254,2253,2253,2240,1483,2249,2221,1881,2232,2204,2195,2231,2153,1863,1898,2201,1957,2150,2157,2158,2184,2181,2038,2146,2016,2154,2107,2069,1808,1948,2117,2042,2062,1949,2036,2110,2011,2099,1888,1910,1826,2004,1893,1719,2080,1970,2084,2123,1967,2049,2010,2023,2036,2042,2054,2014,1997,1731,1973,2040,1828,1987,1930,1774,1659,1934,1950,2009,1997,1945,1745,1954,1906,1957,1906,1916,1926,1990,1904,1767,1928,1903,1782,1883,1905,1839,1793,1672,1883,1725,1564,1850,1921,1827,1854,1745,1490,1842,1480,1517,1895,1817,1831,1728,1827,1735,1800,1857,1841,1807,1759,1742,1796,1783,1829,1706,1774,1671,1741,1757,1671,1663,1755,1725,1763,1720,1562,1703,1586,1734,1687,1716,1759,1601,1687,1673,1716,1672,1536,1689,1558,1692,1521,1524,1690,1688,1578,1667,1692,1689,1652,1679,1644,1602,1652,1642,1637,1531,1676,1650,1698,1694,1471,1508,1655,1510,1654,1626,1619,1608,1624,1593,1644,1671,1502,1618,1646,1511,1640,1620,1479,1254,1614,1596,1582,1414,1600,1351,1513,1621,1607,1601,1558,1356,1541,1575,1575,1285,1554,1556,1548,1564,1573,1509,1560,1394,1436,1331,1519,1548,1527,1427,1589,1505,1539,1527,1426,1544,1524,1509,1511,1517,1550,1506,1530,1502,1503,1549,1520,1527,1525,1503,1559,1527,1476,1361,1526,1283,1496,1442,1428,1476,1492,1472,1268,1402,1483,1484,1523,1339,1448,1484,1284,1452,1141,1455,1480,1456,1413,1444,1375,1348,1435,1310,1449,1435,1403,1414,1426,1404,1427,1403,1396,1354,1429,1439,1420,1383,1415,1438,1401,1386,1373,1311,1437,1378,1383,1383,1439,1330,1074,1225,1420,1285,1332,1390,1402,1358,1381,1394,1367,1161,1386,1367,1384,1381,1065,1390,1357,1370,1311,1381,1180,1345,1154,1311,1374,1369,1352,1119,1339,1303,1379,1216,1043,1322,1366,1230,1367,1380,1214,1278,1353,1382,1201,1333,1338,1372,1346,1354,1336,1364,1322,1134,1299,1313,1237,1321,1247,1312,937,1336,1305,1271,1304,1285,1124,1270,1290,1280,1295,1289,1312,1226,1304,1055,1270,1300,1280,1299,1248,1118,1287,1228,1285,1275,1276,1167,1266,1116,1261,1033,1129,1247,1276,1255,1269,1181,1265,1228,1083,1246,1204,1227,1174,1260,1212,1257,1194,1081,1241,1229,1228,1163,1248,1180,1237,1239,1231,1219,1218,1146,1174,1207,1200,1227,1208,1012,1183,1078,1205,1208,1091,1140,1219,977,1203,1201,1166,1215,1098,1143,1104,1163,1164,1178,1177,963,1127,990,1101,1087,1108,1162,1093,1133,1138,1128,1115,1130,1144,962,1125,1143,1135,1137,1144,1127,1142,782,1084,1023,1130,944,1022,1094,1101,1046,1011,1132,1112,1060,1089,1059,1097,1030,1090,1087,1057,1122,1112,1074,929,1051,1108,1079,1086,1087,1043,1097,1070,1074,1111,1102,1071,943,1076,1065,1076,1025,1096,1030,1063,1053,996,1035,1001,1046,1080,1054,882,988,1015,1063,1080,1031,1025,1030,1017,1058,1053,1061,919,1053]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th>term<\/th>\n      <th>term_count<\/th>\n      <th>doc_count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<hr />
<p>Create the document term matrix here:</p>
<pre class="r"><code>dtm &lt;- create_dtm(it_all, vocab_vectorizer(vocabulary))
dim(dtm)</code></pre>
<pre><code>## [1] 152361  75900</code></pre>
<p>This matrix has a row per document and all the terms (76K) in th columns.</p>
<p>We know we have between 15 and 20 big beer type categories from the previous post. So we might reasonably assume the optimal number of topics might be in the same range. There are however more objective ways to calculate the optimal number of topics. More information can be found in <a href="http://text2vec.org/topic_modeling.html">this</a> article of Dmitry Selivanov.</p>
<pre class="r"><code>set.seed(42)
lda_model = LDA$new(n_topics = 15, doc_topic_prior = 0.1, topic_word_prior = 0.01)
doc_topic_distr = 
  lda_model$fit_transform(x = dtm, n_iter = 1000, 
                          convergence_tol = 0.001, n_check_convergence = 25,
                          progressbar = FALSE)</code></pre>
<pre><code>## INFO [2019-12-14 21:10:47] iter 25 loglikelihood = -72036337.832
## INFO [2019-12-14 21:11:22] iter 50 loglikelihood = -70282091.670
## INFO [2019-12-14 21:11:56] iter 75 loglikelihood = -69526872.235
## INFO [2019-12-14 21:12:30] iter 100 loglikelihood = -69049401.403
## INFO [2019-12-14 21:13:06] iter 125 loglikelihood = -68699549.660
## INFO [2019-12-14 21:13:41] iter 150 loglikelihood = -68443008.232
## INFO [2019-12-14 21:14:15] iter 175 loglikelihood = -68237526.129
## INFO [2019-12-14 21:14:49] iter 200 loglikelihood = -68074569.228
## INFO [2019-12-14 21:15:23] iter 225 loglikelihood = -67952373.320
## INFO [2019-12-14 21:15:57] iter 250 loglikelihood = -67839507.522
## INFO [2019-12-14 21:16:31] iter 275 loglikelihood = -67754473.559
## INFO [2019-12-14 21:17:06] iter 300 loglikelihood = -67675455.131
## INFO [2019-12-14 21:17:40] iter 325 loglikelihood = -67617317.999
## INFO [2019-12-14 21:17:40] early stopping at 325 iteration</code></pre>
<pre class="r"><code>lda_model$get_top_words(n = 15, topic_number = c(1:10), lambda = 0.4) %&gt;% 
  datatable(class = &quot;compact&quot;)</code></pre>
<div id="htmlwidget-4" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4">{"x":{"filter":"none","data":[["fantome","saison","funk","funky","gueuze","cantillon","brett","cheese","barnyard","wild","hay","lemon","horse","wet","musty"],["cherry","sour","raspberry","red","pink","lambic","raspberries","like","sweet","juice","cherries","tart","strawberry","soda","artificial"],["herbal","character","palate","soft","hop","phenols","phenolic","leafy","esters","bitterness","tropical","spicy","hops","note","malt"],["nice","good","pretty","taste","smell","little","well","decent","overall","lacing","amount","drinkability","color","mouthfeel","golden"],["citrus","wheat","lemon","coriander","orange","yellow","white","light","straw","pale","peel","golden","refreshing","zest","pepper"],["dark","brown","raisins","fruits","figs","plums","sugar","caramel","dates","tan","raisin","toffee","prunes","plum","molasses"],["first","tongue","alcohol","sip","mouth","warmed","pour","really","bubbles","around","get","back","smell","bottom","throat"],["sour","oak","tart","vinegar","funk","sourness","acidic","lactic","tartness","acidity","funky","acetic","puckering","cherry","barnyard"],["chocolate","coffee","black","stout","roasted","dark","roast","cocoa","roasty","bourbon","smoke","licorice","brown","milk","mocha"],["yeast","malt","caramel","candi","balance","sugar","medium","moderate","earthiness","belgian","complexity","light","bready","reduces","aromas"]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th>V1<\/th>\n      <th>V2<\/th>\n      <th>V3<\/th>\n      <th>V4<\/th>\n      <th>V5<\/th>\n      <th>V6<\/th>\n      <th>V7<\/th>\n      <th>V8<\/th>\n      <th>V9<\/th>\n      <th>V10<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<hr />
<p>These are per topic our top relevant words.</p>
<p>We can further explore the model using the LDAvis visualisation. See the <a href="https://pdfs.semanticscholar.org/13e4/4c96680b503f799726819c56da361b20bf56.pdf?_ga=2.226180253.663369543.1576144903-72870196.1576144903">article</a> by the creators if you want more information.</p>
<pre class="r"><code>lda_model$plot(out.dir = &quot;~/R/blogs/static/img/20191212/ldavis/&quot;, open.browser = FALSE)</code></pre>
<pre><code>## Warning in dir.create(out.dir): &#39;C:
## \Users\William\Documents\R\blogs\static\img\20191212\ldavis&#39; already exists</code></pre>
<pre><code>## Loading required namespace: servr</code></pre>
<p>The frame is a bit too big to be incorporated nicely in the markdown file, but it works.</p>
<iframe width="1275px" height="850px" src="https://badtothecode.netlify.com/img/20191212/ldavis/index.html#topic=9&amp;lambda=0.4&amp;term=">
<p>
Your browser does not support iframes
</p>
</iframe>
<p>The ‘get_top_words’ function gives the most relevant words in the topics (with lambda = 0.4), but does not return a relevance score. So digging into the function to see if we can obtain it:</p>
<pre class="r"><code>lambda &lt;- 0.4
n &lt;- 15
topic_word_distribution &lt;- lda_model$topic_word_distribution
topic_word_freq &lt;- lambda * log(topic_word_distribution) + 
    (1 - lambda) * log(t(t(topic_word_distribution)/
                           (colSums(lda_model$components)
                            /sum(lda_model$components))))

df_freq &lt;- as.data.frame(t(topic_word_freq)) %&gt;% 
  rownames_to_column(&quot;word&quot;) %&gt;% 
  pivot_longer(-word, names_to = &quot;topic&quot;, values_to = &quot;relevance&quot;)

top_terms &lt;- df_freq %&gt;%
  group_by(topic) %&gt;%
  top_n(5, relevance) %&gt;%
  ungroup() %&gt;%
  arrange(topic, -relevance)

head(top_terms, 10)</code></pre>
<pre><code>## # A tibble: 10 x 3
##    word    topic relevance
##    &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;
##  1 fantome V1       -0.563
##  2 saison  V1       -0.586
##  3 funk    V1       -0.614
##  4 funky   V1       -0.687
##  5 gueuze  V1       -0.743
##  6 yeast   V10      -0.480
##  7 malt    V10      -0.560
##  8 caramel V10      -0.691
##  9 candi   V10      -0.710
## 10 balance V10      -0.726</code></pre>
<p>We then can plot these scores:</p>
<pre class="r"><code>top_terms %&gt;%
  mutate(order = as.integer(str_remove(topic, &quot;V&quot;))) %&gt;%
  arrange(order) %&gt;% 
  mutate(topic = factor(topic),
         term = tidytext::reorder_within(word, relevance, topic)) %&gt;%
  ggplot(aes(term, relevance, fill = topic)) +
   scale_fill_viridis(discrete = TRUE, option = &quot;D&quot;) +
  geom_bar(alpha = 0.8, stat = &quot;identity&quot;, show.legend = FALSE) +
  tidytext::scale_x_reordered() +
  facet_wrap(~ order, scales = &quot;free&quot;, ncol = 3) +
  coord_flip() +
  theme_minimal() +
  theme(axis.text=element_text(size=14),
        axis.title=element_text(size=28,face=&quot;bold&quot;)) + 
  theme(strip.text.x = element_text(size = 14, colour = &quot;black&quot;))</code></pre>
<p><img src="/post/2019-12-12-topic-modeling-beer-reviews_files/figure-html/unnamed-chunk-13-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>Now we can see in what topics the model classifies the different reviews in.</p>
<pre class="r"><code>set.seed(42)
doc_topic_distr &lt;- 
  lda_model$fit_transform(x = dtm, n_iter = 1000, 
                          convergence_tol = 0.001, n_check_convergence = 25, 
                          progressbar = FALSE)</code></pre>
<pre><code>## INFO [2019-12-14 21:18:33] iter 25 loglikelihood = -72036337.832
## INFO [2019-12-14 21:19:07] iter 50 loglikelihood = -70282091.670
## INFO [2019-12-14 21:19:41] iter 75 loglikelihood = -69526872.235
## INFO [2019-12-14 21:20:16] iter 100 loglikelihood = -69049401.403
## INFO [2019-12-14 21:20:50] iter 125 loglikelihood = -68699549.660
## INFO [2019-12-14 21:21:24] iter 150 loglikelihood = -68443008.232
## INFO [2019-12-14 21:21:58] iter 175 loglikelihood = -68237526.129
## INFO [2019-12-14 21:22:32] iter 200 loglikelihood = -68074569.228
## INFO [2019-12-14 21:23:06] iter 225 loglikelihood = -67952373.320
## INFO [2019-12-14 21:23:39] iter 250 loglikelihood = -67839507.522
## INFO [2019-12-14 21:24:13] iter 275 loglikelihood = -67754473.559
## INFO [2019-12-14 21:24:47] iter 300 loglikelihood = -67675455.131
## INFO [2019-12-14 21:25:21] iter 325 loglikelihood = -67617317.999
## INFO [2019-12-14 21:25:21] early stopping at 325 iteration</code></pre>
<p>For instance review 4003:</p>
<pre class="r"><code>review_n &lt;- 4003

df_rev &lt;- as.data.frame(doc_topic_distr[review_n, ])
names(df_rev) &lt;- &quot;proportion&quot;
df_rev &lt;- rownames_to_column(df_rev, &quot;topic&quot;) 

df_rev &lt;- df_rev %&gt;% 
  mutate(topic = as.numeric(topic))

ggplot(data=df_rev, aes(x=topic, y=proportion, fill = topic)) +
  scale_fill_viridis(discrete = FALSE)+
  geom_bar(stat=&quot;identity&quot;, show.legend= FALSE) +
  scale_x_continuous(&quot;topic&quot;, labels = as.character(df_rev$topic), breaks = df_rev$topic) +
  theme_minimal() +
  theme(text = element_text(size=25))</code></pre>
<p><img src="/post/2019-12-12-topic-modeling-beer-reviews_files/figure-html/unnamed-chunk-15-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>So this review scores the highest in topics 6, 13 and 4. The review points to a darker, stronger brew.</p>
<pre class="r"><code>input_cleaned %&gt;% 
  select(beer_type, beer_name, review) %&gt;% 
  slice(review_n) %&gt;% 
  datatable(rownames = FALSE,  options = list(dom  = &#39;t&#39;))</code></pre>
<div id="htmlwidget-5" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5">{"x":{"filter":"none","data":[["Belgian Strong Dark Ale"],["Grande Réserve (Blue)"],["a the beer poured cloudy brown into a goblet it had a pillowy head that was off white in color suspended the yeast particles resembled nutmeg on eggnog and left nice lacing patterns there are also lots of particles floating near the bottom s complex aromas of dark fruits provide for a rather sweet smell in the nose particularly as the beer warms up notes of grapes and plums really stand out to my nostrils t dominated with flavors of dark fruits the taste shares a lot of similarities with the aroma some flavors of spices are also detectable m it feels medium bodied on the palate and very smooth there is a slight amount of dryness in the finish d although the alcohol is well masked this beer is a great beer to sip and savor all of the complexities in the aroma and taste"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>beer_type<\/th>\n      <th>beer_name<\/th>\n      <th>review<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<hr />
<p>What are the reviews by beer category or beer that have the highest ranking scores per topic? The matrix gives us the topic scores per review and the data frame has the rest of the data. We can bind them together for further analysis.</p>
<pre class="r"><code>df_beer_type &lt;- doc_topic_distr %&gt;%
  cbind(input_cleaned)

names(df_beer_type)</code></pre>
<pre><code>##  [1] &quot;1&quot;              &quot;2&quot;              &quot;3&quot;              &quot;4&quot;             
##  [5] &quot;5&quot;              &quot;6&quot;              &quot;7&quot;              &quot;8&quot;             
##  [9] &quot;9&quot;              &quot;10&quot;             &quot;11&quot;             &quot;12&quot;            
## [13] &quot;13&quot;             &quot;14&quot;             &quot;15&quot;             &quot;brewery&quot;       
## [17] &quot;beer_name&quot;      &quot;beer_type&quot;      &quot;ranked_overall&quot; &quot;ranked_type&quot;   
## [21] &quot;av_rating&quot;      &quot;ratings&quot;        &quot;pDev&quot;           &quot;n_reviews&quot;     
## [25] &quot;notes&quot;          &quot;i&quot;              &quot;timestamp&quot;      &quot;hash&quot;          
## [29] &quot;n_words&quot;        &quot;review&quot;</code></pre>
<p>Haha me happy now. We can now analyse our topics according to our dimensions (beer type, brewery, beer…).</p>
<p>Topic fourteen for instance seems now to be the topic of the reviews of beers people liked:</p>
<pre class="r"><code>df_beer_type %&gt;% 
  select(&#39;14&#39;, beer_name, brewery, review) %&gt;% 
  arrange(desc(`14`)) %&gt;% 
  select(-&#39;14&#39;) %&gt;% 
  slice(1:25) %&gt;% 
  datatable(class = &quot;compact&quot;)</code></pre>
<div id="htmlwidget-6" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25"],["Première (Red)","Nostradamus","N'Ice Chouffe","Trappistes Rochefort 10","St. Sebastiaan Dark","Duchesse De Bourgogne","Westmalle Trappist Dubbel","Trappist Westvleteren 12 (XII)Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Trappist Westvleteren 12 (XII)Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Trappist Westvleteren 8 (VIII)Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Goudenband","Trappist Westvleteren 12 (XII)Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Abt 12","Orval Trappist Ale","Christmas Ale","Trappistes Rochefort 10","Delirium Tremens","Piraat","Trappistes Rochefort 10","Gulden Draak","Westmalle Trappist Dubbel","Duvel Belgian Golden Ale","Trappistes Rochefort 10","Trignac ","Grande Réserve (Blue)"],["Bières de Chimay","Brasserie Caracole","Brasserie d'Achouffe","Brasserie de Rochefort","Brouwerij Sterkens N.V.","Brouwerij Verhaeghe","Brouwerij Westmalle","Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Brouwerij Liefmans","Brouwerij Westvleteren (Sint-Sixtusabdij van Westvleteren)","Brouwerij St. Bernardus NV","Brasserie d'Orval S.A.","Brouwerij St. Bernardus NV","Brasserie de Rochefort","Brouwerij Huyghe","Brouwerij Van Steenberge N.V.","Brasserie de Rochefort","Brouwerij Van Steenberge N.V.","Brouwerij Westmalle","Brouwerij Duvel Moortgat NV","Brasserie de Rochefort","Brouwerij Van Honsebrouck N.V.","Bières de Chimay"],["definitely one of the best beers in the world has an extremely well balanced taste this belgian beer is the one i introduce to my wine friends due to its complexity and wide range of flavors i love the chimay line and i m able to get bottles of the red for around which makes this extremely hard to beat","one of the best brown ales out there smooth texture and great taste with a abv makes it perfect to enjoy a couple at a time highly recommend","all i can say is why have i not had this beer yet really really dangerous high octane concoction that is delicious does this have alcohol in it i don t taste any will be having again simple pleasantly fruity and very well crafted highly recommended","certainly an excellent quad flavorful smooth not overbearing personally i like st bernardus abt a bit better but this is really subjective highly recommended","there may not be much variety in the taste but this is one of the most friendly dark beers you ll find goes extremely well with food comforting nutty flavor pleasant smell great mouthfeel and pleasant appearance well worth the world class rating it gets from the bros if you drink this while not eating ymmv","other bas have described this one perfectly already so i ll spare you a whole review but this is one of the most tasteful flavorful beer i have ever tried incredible world class without a doubt","new to reviewing but i had to say this about this beer wow i was given a bottle and now i can t wait to find more definitely the best beer i have ever tried and the one thing that i can say to describe this lucious nectar is balance","my palate tends to appreciate the blunt instrument of hops but this is obviously world class in its category opened my bottle in may highly recommend","this is hard to describe but it s one of those beers you have to have at least once everything about it was phenomenal and impossible to realize that it comes in at my wife who is not a beer drinker thoroughly enjoyed this as well","the most perfect beer ever made westvleteren s unique yeasty flavor in their beers is unparalleled and each westvleteren you drink will be an experience you never forget trappist beer at its best","this beer is nothing short of amazing i could drink it every night i found it incredibly complex yet surprisingly smooth the intense flavors were a treat to my palate the scent and mouth feel was nothing short of intoxicating definitely one of my favorites","reviews after a blind tasting including abt and rochefort this was my favorite of the three this was just so incredibly smooth and easy to drink it was everything i hoped for with all the hype around it can t wait to see how this one ages with the other two bottles i have","score really i mean it s good and i could see the score being justified back in but with all of the stellar beer currently on the market personally i think this one s a tad bit over hyped i d describe the beer as a complex fruity belgium style beer and by complex i mean there s an abundance of competing flavors which overlap one another personally i enjoy a beer where a few flavors make their presence known and a certain flavor has a chance to stand out amongst the others","poured into orval chalice thick velvety head lasts forever smooth taste balances all the ingredients perfectly very drinkable even with the higher abv this is close to a perfect beer","a brilliant holiday ale my favorite in fact rich and complex with tones of delightful spice surprisingly easy to drink quickly though i wouldn t recommend rushing this one","superb quad best i ve ever tasted in fact this ranks among my top favorite beers of any style most definitely lives up to its well deserved and stellar reputation","one of my all time favorites if you like strong belgian ales you ll love this beer i love to drink it slowly starting cold and warming up the flavors change with the temperature","what s not to like about this beer an excellent belgium offering that i ve always enjoyed fruity malty and creamy with a full rich taste when i see it i usually pick up a few","definitely one of the best beers i have ever tried maybe the best one and the best beer from trappistes rochefort brewery strongly recommend this amazing quadrupel beer","definitely an exceptional beer hard to find here in the states but a treat when you get a bottle it s a classic example of belgium s best this one will lay you down if you re not careful","what can you say about the belgian trappist dubbels that hasn t already been said well deserved of it s reputation and rating this is a beauty to be savored","a this is an example of why our friends in belgium have their deserved reputation like mary poppins it is practically perfect in every way i am not articulate enough to truly sing proper praise in short it is on a very short list of the best i have ever had period","truly an amazing world class beer it has become my favorite and my go to beer of choice impressive in everyway i believe it is better than st bernardus and it holds its own with westvleteren its definitely a big beer and should be sipped from a wide mouthed chalice alcohol is well hidden well crafted and enjoyable for sure my favorite and may be the bedt beer on the planet i highly recommend","unique and delicious also my beer on beer advocate so personally even more memorable for me highly recommended no matter what number it is for you","this is my favorite everyday beer right now don t let the high abv fool you this beer is not boozy at all the head has great retention and lasts as long as you want it too sorry for the short review but i am not the greatest at picking out the smallest of flavors"]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>beer_name<\/th>\n      <th>brewery<\/th>\n      <th>review<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"order":[],"autoWidth":false,"orderClasses":false,"columnDefs":[{"orderable":false,"targets":0}]}},"evals":[],"jsHooks":[]}</script>
<p>It might be interesting to look at the top 10% of comments per topic score. And analyse the beers and beer types of these topic. For instance for topic 1:</p>
<pre class="r"><code>df_beer_type %&gt;% 
  select(&#39;1&#39;, beer_name, brewery, beer_type, review) %&gt;% 
  arrange(desc(`1`)) %&gt;% 
  filter(ntile(`1`, 100) &gt; 90)%&gt;% group_by(beer_type) %&gt;% 
  summarise(sum = sum(`1`)) %&gt;% 
  arrange(desc(sum))</code></pre>
<pre><code>## # A tibble: 50 x 2
##    beer_type                  sum
##    &lt;chr&gt;                    &lt;dbl&gt;
##  1 Belgian Gueuze          1423. 
##  2 Belgian Saison          1155. 
##  3 Belgian Fruit Lambic    1107. 
##  4 Belgian Lambic           386. 
##  5 Belgian Pale Ale         265. 
##  6 Belgian Strong Pale Ale  240. 
##  7 Belgian Tripel           156. 
##  8 Belgian Strong Dark Ale  104. 
##  9 Belgian Witbier           61.2
## 10 Flanders Red Ale          60.3
## # ... with 40 more rows</code></pre>
<p>So for topic one, the sum of the scores of the highest 10% are the highest for Belgian Triple style of beer.</p>
<p>One possibility to analyse the top 10% over the topics, is to nest all the reviews per topic and then to map on the result.</p>
<pre class="r"><code>df_nested &lt;- df_beer_type %&gt;% 
  select(1:15, beer_type) %&gt;% 
  pivot_longer(1:15, names_to=&quot;topic&quot;) %&gt;% 
  nest(data = c(beer_type, value)) 

df_nested</code></pre>
<pre><code>## # A tibble: 15 x 2
##    topic           data
##    &lt;chr&gt; &lt;list&lt;df[,2]&gt;&gt;
##  1 1      [152,361 x 2]
##  2 2      [152,361 x 2]
##  3 3      [152,361 x 2]
##  4 4      [152,361 x 2]
##  5 5      [152,361 x 2]
##  6 6      [152,361 x 2]
##  7 7      [152,361 x 2]
##  8 8      [152,361 x 2]
##  9 9      [152,361 x 2]
## 10 10     [152,361 x 2]
## 11 11     [152,361 x 2]
## 12 12     [152,361 x 2]
## 13 13     [152,361 x 2]
## 14 14     [152,361 x 2]
## 15 15     [152,361 x 2]</code></pre>
<p>We just nested the 152K rows in 15.</p>
<p>And now using purrr’s map:</p>
<pre class="r"><code>df_top_topic &lt;- df_nested %&gt;% 
  mutate(top = map(data, ~filter(.x, ntile(value, 100) &gt; 90)))

df_top &lt;- df_top_topic %&gt;% 
  select(-data) %&gt;% 
  unnest(c=(&quot;top&quot;))

df_top %&gt;% group_by(topic, beer_type) %&gt;% 
  summarise(topic_score = sum(value)) %&gt;% 
  filter(topic == 12) %&gt;% 
  arrange(desc(topic_score))</code></pre>
<pre><code>## # A tibble: 65 x 3
## # Groups:   topic [1]
##    topic beer_type                topic_score
##    &lt;chr&gt; &lt;chr&gt;                          &lt;dbl&gt;
##  1 12    European Pale Lager             619.
##  2 12    Belgian Strong Pale Ale         611.
##  3 12    Belgian Strong Dark Ale         592.
##  4 12    Belgian Quadrupel (Quad)        485.
##  5 12    Belgian Witbier                 416.
##  6 12    Belgian Tripel                  385.
##  7 12    Belgian Dubbel                  341.
##  8 12    Belgian Pale Ale                341.
##  9 12    Belgian Fruit Lambic            328.
## 10 12    Belgian Saison                  260.
## # ... with 55 more rows</code></pre>
<p>We obtain per topic and per beer type the sum of the topic scores of the reviews with the highest scores per topic.</p>
<pre class="r"><code>df &lt;- df_top %&gt;% group_by(topic, beer_type) %&gt;% 
  summarise(topic_score = sum(value)) %&gt;% 
  arrange(desc(topic_score)) %&gt;% 
  top_n(5) %&gt;% 
  ungroup() %&gt;%
  mutate(topic = as.numeric(topic)) %&gt;% 
  filter(!beer_type %in% c(&quot;Russian Imperial Stout&quot;,
                           &quot;American Imperial Stout&quot;,
                           &quot;Belgian Blonde Ale &quot;))</code></pre>
<pre><code>## Selecting by topic_score</code></pre>
<pre class="r"><code>ggplot(data = df, aes(x = topic, y= beer_type)) +
  geom_point(aes(color= factor(beer_type)),size = df$topic_score/70, alpha = 1/4) +
  theme_minimal() +
  theme(legend.position = &quot;none&quot;) +
  coord_cartesian(xlim =c(0.8, 16), ylim =c(0, 18)) +
  scale_x_continuous(breaks = seq(1, 15, by = 1)) +
  geom_vline(xintercept = 1:15, alpha = 0.15) +
  labs(y=NULL) +
  theme(text = element_text(size=25))</code></pre>
<p><img src="/post/2019-12-12-topic-modeling-beer-reviews_files/figure-html/unnamed-chunk-22-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>I like this way of presenting things even if interpretation needs to be a bit careful. The plot makes the topics a bit more palatable as it were.</p>
<p>There are still is a s*** load of avenues to explore with topic modeling and I’m sure we will get back to them, but this post is already a bit too long so concluding here with the mapping of the 20 most commented beers with the same analysis frame.</p>
<pre class="r"><code>top_beers &lt;- df_beer_type %&gt;% 
  group_by(beer_name) %&gt;% 
  count() %&gt;% 
  arrange(desc(n)) %&gt;% 
  head(20)

df_top_beer &lt;- df_beer_type %&gt;% 
  filter(beer_name %in% top_beers$beer_name) %&gt;% 
  select(1:15, beer_name) %&gt;% 
  pivot_longer(1:15, names_to=&quot;topic&quot;) %&gt;% 
  nest(data = c(beer_name, value)) 

df_top &lt;- df_top_beer %&gt;% 
  mutate(top = map(data, ~filter(.x, ntile(value, 100) &gt; 90)))

df &lt;- df_top %&gt;% 
  select(-data) %&gt;% 
  unnest(c=(&quot;top&quot;)) %&gt;% 
  group_by(topic, beer_name) %&gt;% 
  summarise(topic_score = sum(value)) %&gt;% 
  arrange(desc(topic_score)) %&gt;% 
  top_n(5) %&gt;% 
  ungroup() %&gt;%
  mutate(topic = as.numeric(topic)) %&gt;% 
  mutate(beer_name = substr(beer_name, 1, 25))</code></pre>
<pre><code>## Selecting by topic_score</code></pre>
<pre class="r"><code>ggplot(data = df, aes(x = topic, y= beer_name)) +
  geom_point(aes(color= factor(beer_name)),size = df$topic_score/10, alpha = 1/4) +
  theme_minimal() +
  theme(legend.position = &quot;none&quot;) +
  coord_cartesian(xlim =c(1, 15.5), ylim =c(0, 18)) +
  scale_x_continuous(breaks = seq(1, 15, by = 1)) +
  geom_vline(xintercept = 1:15, alpha = 0.15) +
  labs(y=NULL) +
  theme(text = element_text(size=25))</code></pre>
<p><img src="/post/2019-12-12-topic-modeling-beer-reviews_files/figure-html/unnamed-chunk-23-1.png" width="1152" style="display: block; margin: auto;" /></p>
<p>So here again we can see which beers are in the highly rated topic (14).</p>
<p>See you next time, cheers.</p>
