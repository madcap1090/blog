---
title: happy faces in a bucket
author: William Bourgeois
date: '2019-05-11'
slug: happy-faces-in-a-bucket
categories: []
tags:
  - Belgian politics
  - AWS Recognition
  - Facial analysis
  - Boto3
  - S3
  - Sagemaker
---

Remember we downloaded the pictures of our parliamentarians and made a patchwork with them? I looked for a while how to analyse for gender, age and skin color. One obvious candidate was Rekognition for AWS if only because the instances that are at my workplace decided to use AWS services. Getting a little bit more familiar with using AWS services seemed like a good choice. 

I searched for R packages to use Rekognition with, but did not find any. So I tried Python's Boto3 but could not get the authorisation working. So with a little (a very little) help from the new consultants (thank you Fabrice) I set out to use my first scripts on the cloud.

```{r message=TRUE, warning=TRUE}
# libraries
library("tidyverse")
library("aws.s3")
library("magick")
options(Encoding="UTF-8")
```

In the process I found out Recognition did not treat gifs, so the pictures need to be converted first to jpgs.

```{r, eval=FALSE,}
to_move <- list.files("./data/190417", pattern = "*.gif")
file.copy(file.path("./data/190417", to_move), "./data/20190511")
```

Returns TRUE and TRUE is good. TRUE will set you free. We can convert them with the magick package. 

```{r}
convert_ye <- function(gif){
  pic <- image_read(gif)
  name <- str_remove(gif,".gif")
  
  image_write(pic, path = paste0("./jpg/",name,".jpg"), format = "jpg")
}

headens <- list.files("./data/20190511", pattern = "*.gif", full.names = TRUE)
```

```{r, eval=FALSE, warning=FALSE}
convert_ye(headens)
```

Returns;

Error in magick_image_readpath(path, density, depth, strip) : Magick: UnableToOpenBlob `C:\Users\William\Documents\R\blogs\content\post\data\20190511\Caprasse VÃ©ronique.gif': No such file or directory @ error/blob.c/OpenBlob/2701


In encoding hell again. The headens cannot be converted.  Can't really find a way to solve this. Last time we just gave the files numbers. We can do that again, but now we will keep the names for further use. Or we can try to replace it just for the magick package and change it again once we have the jpgs. 

```{r, eval=FALSE,}

headens <- list.files("./data/20190511")

setwd("./data/20190511")
dir.create(file.path("jpg"), showWarnings = FALSE)
for(i in (1:length(headens))){
  # print(headens[i])
  file.rename(from = headens[i], paste0(i,".gif"))
  pic <- image_read(paste0(i, ".gif"))
  name <- str_remove(headens[i],".gif")
  image_write(pic, path = paste0("./jpg/",name,".jpg"), format = "jpg")
}

```

That seemed to work.

In comes AWS. We will upload these to a bucket S3. It is important that the bucket is in the same Amazon Region as your stagemaker instance. I wrote 'instance' because it sounds good, I don't know if it really means something though. But it sounds like a cloud computing word to use.  

The auhentication can be done like this:

```{r, eval=FALSE}
AWSAccessKeyId <- "xxxx"
AWSSecretKey <- "xxxx"
region <- "eu-west-3"


Sys.setenv("AWS_ACCESS_KEY_ID" = AWSAccessKeyId,
           "AWS_SECRET_ACCESS_KEY" = AWSSecretKey,
           "AWS_DEFAULT_REGION" = region,
           "AWS_SESSION_TOKEN" = "")

```

Creating a bucket

```{r, eval=FALSE}
put_bucket("reps666", region = "eu-west-1")
```



And then uploading the pictures to a bucket. 

```{r, eval=FALSE}
# test
put_object("./data/20190511/jpg/Almaci Meyrem.jpg", bucket = "reps666", 
           object = "Almaci Meyrem.jpg")
```

Returnes TRUE. TRUE is good, it will set you free.

```{r,eval=FALSE}
delete_object(object = "Almaci Meyrem.jpg",bucket = "reps666")
```

Repeat after me, TRUE is...

I'm still having problems with encodings, hope you have not, but will change the names to digits and convert them back to names later.

```{r, eval=FALSE}
files <- list.files("./data/20190511/jpg")
files_full <- list.files("./data/20190511/jpg",full.names = TRUE )
for(i in (1:length(files))){
    file.rename(from = files_full[i], paste0("./data/20190511/jpg/",i,".jpg"))
  }
```

And now uploading the files to the bucket.

```{r, eval=FALSE}

files_full <- list.files("./data/20190511/jpg",full.names = TRUE )
for(i in (1:length(files))){
    put_object(files_full[i], bucket = "reps666")
}

```


So we have the pictures in a bucket s3 with digits instead of names, or as names, but at least they are there, on our cloud. 

<center>
![aws console](/img/20190511/Management Console.jpg)

</center>


